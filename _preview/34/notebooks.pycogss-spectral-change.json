{"version":2,"kind":"Notebook","sha256":"fd02e14c2c1ef5c5147d07281bd09a680428c2fd4d3fb6e80bae2f1584a709d5","slug":"notebooks.pycogss-spectral-change","location":"/notebooks/05_pycogss_spectral_change.ipynb","dependencies":[],"frontmatter":{"title":"Use the GeoJSON file to get the Area of Interest and query the STAC catalog for items","content_includes_title":true,"kernelspec":{"name":"osdf","display_name":"python:osdf","language":"python"},"authors":[{"nameParsed":{"literal":"Harsha R. Hampapura","given":"Harsha R.","family":"Hampapura"},"name":"Harsha R. Hampapura","id":"contributors-myst-generated-uid-0"},{"nameParsed":{"literal":"Brian Bockelman","given":"Brian","family":"Bockelman"},"name":"Brian Bockelman","id":"contributors-myst-generated-uid-1"},{"nameParsed":{"literal":"Alexander Hoelzeman","given":"Alexander","family":"Hoelzeman"},"name":"Alexander Hoelzeman","id":"contributors-myst-generated-uid-2"},{"nameParsed":{"literal":"Emma Turetsky","given":"Emma","family":"Turetsky"},"name":"Emma Turetsky","id":"contributors-myst-generated-uid-3"},{"nameParsed":{"literal":"Amandha Wingert Barok","given":"Amandha Wingert","family":"Barok"},"name":"Amandha Wingert Barok","id":"contributors-myst-generated-uid-4"},{"nameParsed":{"literal":"Aashish Panta","given":"Aashish","family":"Panta"},"name":"Aashish Panta","id":"contributors-myst-generated-uid-5"},{"nameParsed":{"literal":"Justin Hiemstra","given":"Justin","family":"Hiemstra"},"name":"Justin Hiemstra","id":"contributors-myst-generated-uid-6"},{"nameParsed":{"literal":"Douglas Schuster","given":"Douglas","family":"Schuster"},"name":"Douglas Schuster","id":"contributors-myst-generated-uid-7"},{"nameParsed":{"literal":"Kibiwott Koech","given":"Kibiwott","family":"Koech"},"name":"Kibiwott Koech","id":"contributors-myst-generated-uid-8"}],"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/osdf-cookbook","copyright":"2024","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/osdf-cookbook/blob/HEAD/notebooks/05_pycogss_spectral_change.ipynb","exports":[{"format":"ipynb","filename":"05_pycogss_spectral_change.ipynb","url":"/osdf-cookbook/_preview/34/build/05_pycogss_spectral_-a622d77b7acdba57688b7c63d5621569.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Imports\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport pandas as pd\nimport xarray as xr\n# import s3fs\nimport re\nfrom pelicanfs.core import PelicanFileSystem, PelicanMap,OSDFFileSystem \n# import fsspec.implementations.http as fshttp\nimport geopandas as gpd\nfrom pystac_client import Client\n# from odc.stac import stac_load\nfrom rasterio.mask import mask\nimport rasterio\nfrom shapely.geometry import box\nfrom urllib.parse import urlparse","key":"O6oE4EzMvz"},{"type":"output","id":"qF03WursREYsvFd6BjTA5","data":[],"key":"PxYn3CdrOb"}],"key":"Gwa6Kiu2ns"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import dask \nfrom dask_jobqueue import PBSCluster\nfrom dask.distributed import Client as dask_client\nfrom dask.distributed import performance_report","key":"eAWA5PF9Xx"},{"type":"output","id":"vLfN1k-Ptd4WWmvss_QX7","data":[],"key":"PUre1v4mBf"}],"key":"AQw97XQX6y"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Use the GeoJSON file to get the Area of Interest and query the STAC catalog for items","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y42R4CE6li"}],"identifier":"use-the-geojson-file-to-get-the-area-of-interest-and-query-the-stac-catalog-for-items","label":"Use the GeoJSON file to get the Area of Interest and query the STAC catalog for items","html_id":"use-the-geojson-file-to-get-the-area-of-interest-and-query-the-stac-catalog-for-items","implicit":true,"key":"TmGtuFvchX"}],"key":"Mg6ZKhTtTL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Load the GeoJSON file\ngeojson_path = '3100180240.geojson' \ngdf = gpd.read_file(geojson_path)\n\n# Display the loaded GeoDataFrame\nprint(gdf)","key":"i2fUD7bgrX"},{"type":"output","id":"5aqqYkrgHMCqvjDt55Ur0","data":[{"name":"stdout","output_type":"stream","text":"                     id  SUB_AREA  COAST     PFAF_ID  DIST_MAIN    HYBAS_ID  \\\n0  00140000000000002983     128.1      0  3512704524      784.3  3100180240   \n\n   DIST_SINK   NEXT_DOWN  ORDER  ENDO    MAIN_BAS   NEXT_SINK   SORT  UP_AREA  \\\n0      784.3  3100180230      4     0  3100009670  3100009670  66318    128.1   \n\n                                            geometry  \n0  POLYGON ((134.51667 66.87917, 134.51752 66.875...  \n"}],"key":"pAxH0K9jGL"}],"key":"P0BaWNs6Ch"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Extract AOI geometry\naoi_geometry = gdf.geometry.iloc[0]\naoi_bounds   = aoi_geometry.bounds  # (minx, miny, maxx, maxy)\n\n# Get AOI centroid for visualization\ncentroid  = aoi_geometry.centroid\nlong, lat = centroid.x, centroid.y\n\n# Print the bounding box to verify\nprint(\"Bounding Box:\", aoi_bounds)","key":"uZcSV2gucG"},{"type":"output","id":"S_2gHg76k7Lcgd-ANoBJo","data":[{"name":"stdout","output_type":"stream","text":"Bounding Box: (134.51666686838126, 66.7708333115583, 134.9046488751149, 66.97083294070578)\n"}],"key":"IXYJqGC5Od"}],"key":"i0frSm24Y4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Connect to the Earth Search STAC API (Sentinel-2 Level-2A COGs are available here)\ncatalog_url = \"https://earth-search.aws.element84.com/v1\"\ncatalog     = Client.open(catalog_url)\n\n# Define the date range as strings\nstart_date      = \"2019-01\"\nend_date        = \"2023-02\"\n\n# Define cloud cover threshold\ncloud_cover_max = 0.05  # 5% cloud cover threshold\n#cloud_cover_max = 0.20  # 20% cloud cover threshold\n\n# Perform the search\nsearch = catalog.search(\n                 collections=[\"sentinel-2-l2a\"],\n                 bbox=aoi_bounds,\n                 datetime=f\"{start_date}/{end_date}\",\n                 #datetime=\"2022-06-01/2022-09-30\",\n                 query={\"eo:cloud_cover\": {\"lt\": cloud_cover_max * 100}}\n                )\n\n# Get all matching items\nitems = list(search.items())\nprint(f\"Found {len(items)} matching items.\")","key":"ZAtk107myK"},{"type":"output","id":"1mYqWrFexdnLeQTd1oo5V","data":[{"name":"stdout","output_type":"stream","text":"Found 258 matching items.\n"}],"key":"VSS6YHR9Ck"}],"key":"bElKjO13UM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Confirm that the matching items are hosted in a aws-us-region by printing out the href links for the first n items\nn=1\n\nfor i, item in enumerate(items[:n]):\n    print(f\"\\nItem {i+1}: {item.id}\")\n    for asset_key, asset in item.assets.items():\n        print(f\"  {asset_key}: {asset.href}\")","key":"BAXrzcGqcD"},{"type":"output","id":"oSPFq5Nme2VwDwUmZffKg","data":[{"name":"stdout","output_type":"stream","text":"\nItem 1: S2B_53WMQ_20230222_0_L2A\n  aot: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/AOT.tif\n  blue: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B02.tif\n  coastal: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B01.tif\n  granule_metadata: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/granule_metadata.xml\n  green: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B03.tif\n  nir: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B08.tif\n  nir08: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B8A.tif\n  nir09: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B09.tif\n  red: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B04.tif\n  rededge1: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B05.tif\n  rededge2: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B06.tif\n  rededge3: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B07.tif\n  scl: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/SCL.tif\n  swir16: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B11.tif\n  swir22: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/B12.tif\n  thumbnail: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/thumbnail.jpg\n  tileinfo_metadata: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/tileinfo_metadata.json\n  visual: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/TCI.tif\n  wvp: https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/W/MQ/2023/2/S2B_53WMQ_20230222_0_L2A/WVP.tif\n  aot-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/AOT.jp2\n  blue-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B02.jp2\n  coastal-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B01.jp2\n  green-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B03.jp2\n  nir-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B08.jp2\n  nir08-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B8A.jp2\n  nir09-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B09.jp2\n  red-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B04.jp2\n  rededge1-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B05.jp2\n  rededge2-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B06.jp2\n  rededge3-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B07.jp2\n  scl-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/SCL.jp2\n  swir16-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B11.jp2\n  swir22-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/B12.jp2\n  visual-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/TCI.jp2\n  wvp-jp2: s3://sentinel-s2-l2a/tiles/53/W/MQ/2023/2/22/0/WVP.jp2\n"}],"key":"fw60oFFMjM"}],"key":"CuyYzXr7SC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from shapely.geometry import mapping\n\n# Reproject AOI to match raster CRS\nfrom pyproj import CRS\nfrom geopandas import GeoSeries","key":"jZMtrNrtI9"},{"type":"output","id":"Miek2oyoQSC15K2IH8IBK","data":[],"key":"zwLWua4y8o"}],"key":"fEMBqLjKNI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def returnOSDFPath(url):\n    \"\"\"\n    Converts a URL to an OSDF path.\n\n    Parameters:\n    - url: URL to convert.\n\n    Returns:\n    - OSDF path.\n    \"\"\"\n    # Parse the URL\n    parsed_url = urlparse(url)\n    \n    # Construct the OSDF path\n    osdf_path = f\"/aws-opendata/us-west-2/sentinel-cogs{parsed_url.path}\"\n    \n    return osdf_path\n","key":"e0BnG6i8d9"},{"type":"output","id":"3ubw3T2K-tR7ZG6DCDUZx","data":[],"key":"Ihl6O425Ly"}],"key":"fwsalEbZgN"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Apply various masks and calculate NDVI","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JNuvcgBLTw"}],"identifier":"apply-various-masks-and-calculate-ndvi","label":"Apply various masks and calculate NDVI","html_id":"apply-various-masks-and-calculate-ndvi","implicit":true,"key":"LsGNMq4gi8"}],"key":"ve5Qr1UIXF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def clp(image_src, aoi_geometry):\n    \"\"\"\n    Clip a raster image to the Area of Interest (AOI).\n\n    Parameters:\n    - image_src: Open rasterio dataset.\n    - aoi_geometry: AOI geometry as a GeoJSON-like object.\n\n    Returns:\n    - Clipped image array and updated metadata.\n    \"\"\"\n    # out_image, out_transform = mask(image_src, [aoi_geometry], crop=True)\n    out_image, out_transform = mask(image_src, aoi_geometry, crop=True)\n    out_meta = image_src.meta.copy()\n    out_meta.update({\n        \"driver\": \"GTiff\",\n        \"height\": out_image.shape[1],\n        \"width\": out_image.shape[2],\n        \"transform\": out_transform\n    })\n    return out_image, out_meta\n\ndef maskWater(image, water_mask):\n    \"\"\"\n    Masks out water pixels using the MODIS water mask.\n\n    Parameters:\n    - image: Raster image to mask.\n    - water_mask: Water mask raster.\n\n    Returns:\n    - Water-masked image.\n    \"\"\"\n    water = water_mask.read(1)  # Read the water mask\n    mask = water < 1  # Mask water pixels (water < 1)\n    image_masked = np.where(mask, image, np.nan)\n    return image_masked\n\ndef maskS2snow(image, snow_prob):\n    \"\"\"\n    Masks snow pixels using the MSK_SNWPRB (Snow Probability Mask).\n\n    Parameters:\n    - image: Raster image to mask.\n    - snow_prob: Snow probability raster.\n\n    Returns:\n    - Snow-masked image.\n    \"\"\"\n    snow = snow_prob.read(1)  # Read the snow probability mask\n    mask = snow < 0.009  # Mask snow pixels (snow probability < 0.9%)\n    image_masked = np.where(mask, image, np.nan)\n    return image_masked\n\ndef maskWhite(image, b2, b3, b4):\n    \"\"\"\n    Masks white pixels by converting RGB to grayscale and applying a threshold.\n\n    Parameters:\n    - image: Raster image to mask.\n    - b2, b3, b4: Blue, Green, and Red bands respectively.\n\n    Returns:\n    - Grayscale-masked image.\n    \"\"\"\n    # Convert RGB to grayscale\n    grayscale = (0.3 * b4.read(1) + 0.59 * b3.read(1) + 0.11 * b2.read(1)) * 1e4\n    mask = grayscale <= 2000  # Mask white pixels (grayscale > 2000)\n    image_masked = np.where(mask, image, np.nan)\n    return image_masked","key":"QbQEzTR4rM"},{"type":"output","id":"nmhTPJPo7_rKIKWwb9O_k","data":[],"key":"Bz6nQDkPCg"}],"key":"ychpG7mq9e"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# Loop through each item in the STAC query\nfor idx, item in enumerate(items, start=1):\n    print(f\"Processing dataset #{idx}\")\n\n    # Check required assets\n    required_assets = [\"red\", \"green\", \"blue\", \"scl\"]\n    if not all(asset in item.assets for asset in required_assets):\n        print(f\"Skipping dataset #{idx}: Missing required assets.\")\n        continue\n\n    # Get asset URLs\n    red_url = item.assets[\"red\"].href\n    green_url = item.assets[\"green\"].href\n    blue_url = item.assets[\"blue\"].href\n    scl_url = item.assets[\"scl\"].href\n\n    # Reproject AOI to match raster CRS\n    with rasterio.open(red_url) as src:\n        raster_crs = CRS(src.crs)\n    aoi_geometry_reprojected = GeoSeries(aoi_geometry).set_crs(gdf.crs).to_crs(raster_crs)\n\n    # Open and clip bands\n    with rasterio.open(red_url) as red_src, \\\n        rasterio.open(green_url) as green_src, \\\n        rasterio.open(blue_url) as blue_src, \\\n        rasterio.open(scl_url) as scl_src:\n\n        aoi_geometry_reprojected = GeoSeries(aoi_geometry).set_crs(gdf.crs).to_crs(raster_crs)\n        raster_bounds = box(*red_src.bounds)\n\n        if not aoi_geometry_reprojected[0].intersects(raster_bounds):\n            print(f\"Warning: AOI does not intersect the bounds of {red_url}. Skipping.\")\n            continue\n\n        # Clip all RGB and SCL bands to AOI\n        red_clipped, red_meta = clp(red_src, aoi_geometry_reprojected)\n        green_clipped, _      = clp(green_src, aoi_geometry_reprojected)\n        blue_clipped, _       = clp(blue_src, aoi_geometry_reprojected)\n        scl_clipped, _        = clp(scl_src, aoi_geometry_reprojected)\n\n        # # Clip water_mask if available\n        # if water_mask_available:\n        #     with rasterio.open(water_mask_url) as water_mask_src:\n        #         water_mask_clipped, _ = clp(water_mask_src, aoi_geometry_reprojected)\n\n        # Apply maskS2clouds\n        # red_masked = maskS2clouds(red_clipped, scl_clipped)\n        # green_masked = maskS2clouds(green_clipped, scl_clipped)\n        # blue_masked = maskS2clouds(blue_clipped, scl_clipped)\n\n        # # Apply maskWater if available\n        # if water_mask_available:\n        #     red_masked = maskWater(red_masked, water_mask_clipped)\n        #     green_masked = maskWater(green_masked, water_mask_clipped)\n        #     blue_masked = maskWater(blue_masked, water_mask_clipped)\n\n        # # Apply maskWhite\n        # red_final = maskWhite(red_clipped, blue_clipped, green_clipped, red_clipped)\n        # green_final = maskWhite(green_clipped, blue_clipped, green_clipped, red_clipped)\n        # blue_final = maskWhite(blue_clipped, blue_clipped, green_clipped, red_clipped)\n\n        print(f\"Dataset #{idx} processed. Ready for visualization or further analysis.\")","key":"k6RpIlB6Td"},{"type":"output","id":"U-16F1q1xu_1XX2tDECaM","data":[{"name":"stdout","output_type":"stream","text":"Processing dataset #1\nDataset #1 processed. Ready for visualization or further analysis.\nProcessing dataset #2\nDataset #2 processed. Ready for visualization or further analysis.\nProcessing dataset #3\nDataset #3 processed. Ready for visualization or further analysis.\nProcessing dataset #4\nDataset #4 processed. Ready for visualization or further analysis.\nProcessing dataset #5\nDataset #5 processed. Ready for visualization or further analysis.\nProcessing dataset #6\nDataset #6 processed. Ready for visualization or further analysis.\nProcessing dataset #7\nDataset #7 processed. Ready for visualization or further analysis.\nProcessing dataset #8\nDataset #8 processed. Ready for visualization or further analysis.\nProcessing dataset #9\nDataset #9 processed. Ready for visualization or further analysis.\nProcessing dataset #10\nDataset #10 processed. Ready for visualization or further analysis.\nProcessing dataset #11\nDataset #11 processed. Ready for visualization or further analysis.\nProcessing dataset #12\nDataset #12 processed. Ready for visualization or further analysis.\nProcessing dataset #13\nDataset #13 processed. Ready for visualization or further analysis.\nProcessing dataset #14\nDataset #14 processed. Ready for visualization or further analysis.\nProcessing dataset #15\nDataset #15 processed. Ready for visualization or further analysis.\nProcessing dataset #16\nDataset #16 processed. Ready for visualization or further analysis.\nProcessing dataset #17\nDataset #17 processed. Ready for visualization or further analysis.\nProcessing dataset #18\nDataset #18 processed. Ready for visualization or further analysis.\nProcessing dataset #19\nDataset #19 processed. Ready for visualization or further analysis.\nProcessing dataset #20\nDataset #20 processed. Ready for visualization or further analysis.\nProcessing dataset #21\nDataset #21 processed. Ready for visualization or further analysis.\nProcessing dataset #22\nDataset #22 processed. Ready for visualization or further analysis.\nProcessing dataset #23\nDataset #23 processed. Ready for visualization or further analysis.\nProcessing dataset #24\nDataset #24 processed. Ready for visualization or further analysis.\nProcessing dataset #25\nDataset #25 processed. Ready for visualization or further analysis.\nProcessing dataset #26\nDataset #26 processed. Ready for visualization or further analysis.\nProcessing dataset #27\nDataset #27 processed. Ready for visualization or further analysis.\nProcessing dataset #28\nDataset #28 processed. Ready for visualization or further analysis.\nProcessing dataset #29\nDataset #29 processed. Ready for visualization or further analysis.\nProcessing dataset #30\nDataset #30 processed. Ready for visualization or further analysis.\nProcessing dataset #31\nDataset #31 processed. Ready for visualization or further analysis.\nProcessing dataset #32\nDataset #32 processed. Ready for visualization or further analysis.\nProcessing dataset #33\nDataset #33 processed. Ready for visualization or further analysis.\nProcessing dataset #34\nDataset #34 processed. Ready for visualization or further analysis.\nProcessing dataset #35\nDataset #35 processed. Ready for visualization or further analysis.\nProcessing dataset #36\nDataset #36 processed. Ready for visualization or further analysis.\nProcessing dataset #37\nDataset #37 processed. Ready for visualization or further analysis.\nProcessing dataset #38\nDataset #38 processed. Ready for visualization or further analysis.\nProcessing dataset #39\nDataset #39 processed. Ready for visualization or further analysis.\nProcessing dataset #40\nDataset #40 processed. Ready for visualization or further analysis.\nProcessing dataset #41\nDataset #41 processed. Ready for visualization or further analysis.\nProcessing dataset #42\nDataset #42 processed. Ready for visualization or further analysis.\nProcessing dataset #43\nDataset #43 processed. Ready for visualization or further analysis.\nProcessing dataset #44\nDataset #44 processed. Ready for visualization or further analysis.\nProcessing dataset #45\nDataset #45 processed. Ready for visualization or further analysis.\nProcessing dataset #46\nDataset #46 processed. Ready for visualization or further analysis.\nProcessing dataset #47\nDataset #47 processed. Ready for visualization or further analysis.\nProcessing dataset #48\nDataset #48 processed. Ready for visualization or further analysis.\nProcessing dataset #49\nDataset #49 processed. Ready for visualization or further analysis.\nProcessing dataset #50\nDataset #50 processed. Ready for visualization or further analysis.\nProcessing dataset #51\nDataset #51 processed. Ready for visualization or further analysis.\nProcessing dataset #52\nDataset #52 processed. Ready for visualization or further analysis.\nProcessing dataset #53\nDataset #53 processed. Ready for visualization or further analysis.\nProcessing dataset #54\nDataset #54 processed. Ready for visualization or further analysis.\nProcessing dataset #55\nDataset #55 processed. Ready for visualization or further analysis.\nProcessing dataset #56\nDataset #56 processed. Ready for visualization or further analysis.\nProcessing dataset #57\nDataset #57 processed. Ready for visualization or further analysis.\nProcessing dataset #58\nDataset #58 processed. Ready for visualization or further analysis.\nProcessing dataset #59\nDataset #59 processed. Ready for visualization or further analysis.\nProcessing dataset #60\nDataset #60 processed. Ready for visualization or further analysis.\nProcessing dataset #61\nDataset #61 processed. Ready for visualization or further analysis.\nProcessing dataset #62\nDataset #62 processed. Ready for visualization or further analysis.\nProcessing dataset #63\nDataset #63 processed. Ready for visualization or further analysis.\nProcessing dataset #64\nDataset #64 processed. Ready for visualization or further analysis.\nProcessing dataset #65\nDataset #65 processed. Ready for visualization or further analysis.\nProcessing dataset #66\nDataset #66 processed. Ready for visualization or further analysis.\nProcessing dataset #67\nDataset #67 processed. Ready for visualization or further analysis.\nProcessing dataset #68\nDataset #68 processed. Ready for visualization or further analysis.\nProcessing dataset #69\nDataset #69 processed. Ready for visualization or further analysis.\nProcessing dataset #70\nDataset #70 processed. Ready for visualization or further analysis.\nProcessing dataset #71\nDataset #71 processed. Ready for visualization or further analysis.\nProcessing dataset #72\nDataset #72 processed. Ready for visualization or further analysis.\nProcessing dataset #73\nDataset #73 processed. Ready for visualization or further analysis.\nProcessing dataset #74\nDataset #74 processed. Ready for visualization or further analysis.\nProcessing dataset #75\nDataset #75 processed. Ready for visualization or further analysis.\nProcessing dataset #76\nDataset #76 processed. Ready for visualization or further analysis.\nProcessing dataset #77\nDataset #77 processed. Ready for visualization or further analysis.\nProcessing dataset #78\nDataset #78 processed. Ready for visualization or further analysis.\nProcessing dataset #79\nDataset #79 processed. Ready for visualization or further analysis.\nProcessing dataset #80\nDataset #80 processed. Ready for visualization or further analysis.\nProcessing dataset #81\nDataset #81 processed. Ready for visualization or further analysis.\nProcessing dataset #82\nDataset #82 processed. Ready for visualization or further analysis.\nProcessing dataset #83\nDataset #83 processed. Ready for visualization or further analysis.\nProcessing dataset #84\nDataset #84 processed. Ready for visualization or further analysis.\nProcessing dataset #85\nDataset #85 processed. Ready for visualization or further analysis.\nProcessing dataset #86\nDataset #86 processed. Ready for visualization or further analysis.\nProcessing dataset #87\nDataset #87 processed. Ready for visualization or further analysis.\nProcessing dataset #88\nDataset #88 processed. Ready for visualization or further analysis.\nProcessing dataset #89\nDataset #89 processed. Ready for visualization or further analysis.\nProcessing dataset #90\nDataset #90 processed. Ready for visualization or further analysis.\nProcessing dataset #91\nDataset #91 processed. Ready for visualization or further analysis.\nProcessing dataset #92\nDataset #92 processed. Ready for visualization or further analysis.\nProcessing dataset #93\nDataset #93 processed. Ready for visualization or further analysis.\nProcessing dataset #94\nDataset #94 processed. Ready for visualization or further analysis.\nProcessing dataset #95\nDataset #95 processed. Ready for visualization or further analysis.\nProcessing dataset #96\nDataset #96 processed. Ready for visualization or further analysis.\nProcessing dataset #97\nDataset #97 processed. Ready for visualization or further analysis.\nProcessing dataset #98\nDataset #98 processed. Ready for visualization or further analysis.\nProcessing dataset #99\nDataset #99 processed. Ready for visualization or further analysis.\nProcessing dataset #100\nDataset #100 processed. Ready for visualization or further analysis.\nProcessing dataset #101\nDataset #101 processed. Ready for visualization or further analysis.\nProcessing dataset #102\nDataset #102 processed. Ready for visualization or further analysis.\nProcessing dataset #103\nDataset #103 processed. Ready for visualization or further analysis.\nProcessing dataset #104\nDataset #104 processed. Ready for visualization or further analysis.\nProcessing dataset #105\nDataset #105 processed. Ready for visualization or further analysis.\nProcessing dataset #106\nDataset #106 processed. Ready for visualization or further analysis.\nProcessing dataset #107\nDataset #107 processed. Ready for visualization or further analysis.\nProcessing dataset #108\nDataset #108 processed. Ready for visualization or further analysis.\nProcessing dataset #109\nDataset #109 processed. Ready for visualization or further analysis.\nProcessing dataset #110\nDataset #110 processed. Ready for visualization or further analysis.\nProcessing dataset #111\nDataset #111 processed. Ready for visualization or further analysis.\nProcessing dataset #112\nDataset #112 processed. Ready for visualization or further analysis.\nProcessing dataset #113\nDataset #113 processed. Ready for visualization or further analysis.\nProcessing dataset #114\nDataset #114 processed. Ready for visualization or further analysis.\nProcessing dataset #115\nDataset #115 processed. Ready for visualization or further analysis.\nProcessing dataset #116\nDataset #116 processed. Ready for visualization or further analysis.\nProcessing dataset #117\nDataset #117 processed. Ready for visualization or further analysis.\nProcessing dataset #118\nDataset #118 processed. Ready for visualization or further analysis.\nProcessing dataset #119\nDataset #119 processed. Ready for visualization or further analysis.\nProcessing dataset #120\nDataset #120 processed. Ready for visualization or further analysis.\nProcessing dataset #121\nDataset #121 processed. Ready for visualization or further analysis.\nProcessing dataset #122\n"}],"key":"rxZx0TVPiS"}],"key":"duY2QF6Efy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# %%time\n# # Using pelicanfs\n# # Loop through each item in the STAC query\n# for idx, item in enumerate(items, start=1):\n#     print(f\"Processing dataset #{idx}\")\n\n#     # Check required assets\n#     required_assets = [\"red\", \"green\", \"blue\", \"scl\"]\n#     if not all(asset in item.assets for asset in required_assets):\n#         print(f\"Skipping dataset #{idx}: Missing required assets.\")\n#         continue\n\n#     # Get asset URLs\n#     red_url = item.assets[\"red\"].href\n#     green_url = item.assets[\"green\"].href\n#     blue_url = item.assets[\"blue\"].href\n#     scl_url = item.assets[\"scl\"].href\n\n#     pel_red_url   = returnOSDFPath(red_url)\n#     pel_green_url = returnOSDFPath(green_url)\n#     pel_blue_url  = returnOSDFPath(blue_url)\n#     pel_scl_url   = returnOSDFPath(scl_url)\n\n#     pelfs = PelicanFileSystem(\"pelican://osg-htc.org\")\n\n    # # Reproject AOI to match raster CRS\n    # with rasterio.open(pel_red_url,opener=pelfs) as src:\n    # with rasterio.open(red_url) as src:\n    #     raster_crs = CRS(src.crs)\n    # aoi_geometry_reprojected = GeoSeries(aoi_geometry).set_crs(gdf.crs).to_crs(raster_crs)\n\n    # # Reproject AOI to match raster CRS\n    # with rasterio.open(pel_red_url, opener=pelfs) as red_src, \\\n    #      rasterio.open(pel_green_url, opener=pelfs) as green_src, \\\n    #      rasterio.open(pel_blue_url, opener=pelfs) as blue_src, \\\n    #      rasterio.open(pel_scl_url, opener=pelfs) as scl_src:\n\n    #     aoi_geometry_reprojected = GeoSeries(aoi_geometry).set_crs(gdf.crs).to_crs(raster_crs)\n    #     raster_bounds = box(*red_src.bounds)\n\n    #     if not aoi_geometry_reprojected[0].intersects(raster_bounds):\n    #         print(f\"Warning: AOI does not intersect the bounds of {red_url}. Skipping.\")\n    #         continue\n\n    #     # Clip all RGB and SCL bands to AOI\n    #     red_clipped, red_meta = clp(red_src, aoi_geometry_reprojected)\n    #     green_clipped, _      = clp(green_src, aoi_geometry_reprojected)\n    #     blue_clipped, _       = clp(blue_src, aoi_geometry_reprojected)\n    #     scl_clipped, _        = clp(scl_src, aoi_geometry_reprojected)\n\n    #     print(f\"Dataset #{idx} processed. Ready for visualization or further analysis.\")","key":"sriRN3AhRn"},{"type":"output","id":"HYhh2ZqgpZVRMZz29cB4T","data":[],"key":"Y9dA9b3uZY"}],"key":"U3Mu0Q2wQa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from sklearn.preprocessing import MinMaxScaler\n# Function to scale image bands properly\ndef scale_band(band):\n    scaler = MinMaxScaler(feature_range=(0, 1))\n    return scaler.fit_transform(band)  # Normalize between 0-1\n\n# Assuming red_clipped, green_clipped, and blue_clipped are 2D NumPy arrays\nrgb = np.dstack((scale_band(red_clipped.squeeze()),\n    scale_band(green_clipped.squeeze()),\n    scale_band(blue_clipped.squeeze()),\n))\n\n# Plot\nplt.figure(figsize=(10, 8))\nplt.imshow(rgb)\nplt.axis(\"off\")\nplt.show()","key":"UXf6atfW6t"},{"type":"output","id":"N_WGClr9jgb73J6cWrQ7d","data":[],"key":"cj4rdoIP5l"}],"key":"JFNE8C3RUr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# def visualize_rgb(red_band, green_band, blue_band, title=\"RGB Composite\"):\n#     \"\"\"\n#     Visualizes an RGB composite of raster bands using matplotlib.\n\n#     Parameters:\n#     - red_band, green_band, blue_band (numpy array): Red, Green, and Blue bands.\n#     - title (str): Title for the plot.\n#     \"\"\"\n#     rgb = np.dstack((\n#         np.clip(red_band, 0, 1),  # Normalize reflectance between 0-1\n#         np.clip(green_band, 0, 1),\n#         np.clip(blue_band, 0, 1)\n#     ))\n#     plt.figure(figsize=(10, 8))\n#     plt.imshow(rgb)\n#     plt.title(title)\n#     plt.axis(\"off\")\n#     plt.show()\n\n# # Example: Visualize RGB composite\n# visualize_rgb(red_clipped, green_clipped, blue_clipped, title=\"Processed RGB Composite\")","key":"O29AaxCuU6"},{"type":"output","id":"_cbbcu2ZARxwZdxMlpY3Y","data":[],"key":"DUgIIBjsJu"}],"key":"KuKIXyeqj7"}],"key":"wcrwzG5BiB"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Init Datasets","url":"/notebooks/init-datasets","group":"NOAA SONAR data examples"},"next":{"title":"Step 1: Importing the libraries","url":"/notebooks/pelican-llc4320","group":"OpenVISUS examples"}}},"domain":"http://localhost:3000"}